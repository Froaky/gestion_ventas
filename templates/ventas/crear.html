{% extends "base.html" %}
{% block title %}Crear Venta{% endblock %}

{% block content %}
<div class="centered-container">
  <h2 >Crear Nueva Venta</h2>

  <form method="POST" class="form" id="ventaForm" >
    <!-- Cliente -->
    <div class="form-group">
      <label for="cliente_id" style="color: black;">Cliente</label><br>
      <select name="cliente_id" id="cliente_id" class="form-control" required>
        <option value="" disabled selected>Selecciona un cliente</option>
        {% for cliente in clientes %}
          <option value="{{ cliente.id }}">{{ cliente.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Selección de productos -->
    <div class="form-group">
      <label for="productoSelect" style="color: black;"> Producto</label><br>
      <select id="productoSelect" class="form-control js-example-basic-single">
        <option value="" disabled selected>Selecciona un producto</option>
        {% for producto in productos %}
          <optgroup label="{{ producto.categoria }}">
            <option value="{{ producto.id }}" data-precio="{{ producto.precio }}" data-nombre="{{ producto.name }}" data-stock="{{ producto.stock }}">
              {{ producto.name }} ({{ producto.stock }} en stock)
            </option>
          </optgroup>
        {% endfor %}
      </select>
      <button type="button" class="btn btn-secondary btn-sm mt-2" id="addProduct">Añadir Producto</button>
    </div>

    <!-- Tabla de productos seleccionados -->
    <div class="form-group">
      <label style="color: black;">Productos</label>
      <table class="table table-bordered mt-2" id="tablaProductos">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Stock</th>
            <th>Precio Unitario</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th>Eliminar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Total calculado automáticamente -->
    <div class="form-group">
      <label for="total" style="color: black;">Total ($)</label>
      <input type="number" step="0.01" name="total" id="total" class="form-control" readonly>
    </div>

    <button type="submit" class="btn btn-primary" >Crear Venta</button>
    
  </form>
</div>


<script id="productosData" type="application/json">
  {{ productos | tojson }}
</script>
<script>
  $(document).ready(function () {
    $('.js-example-basic-single').select2();

    const productosSelect = $('#productoSelect');
    const tablaProductos = $('#tablaProductos tbody');
    let contador = 0;

    function actualizarTotal() {
      let total = 0;
      tablaProductos.find('tr').each(function () {
        const precio = parseFloat($(this).find('.precio-unitario').text()) || 0;
        const cantidad = parseInt($(this).find('.cantidad').val()) || 0;
        const subtotal = precio * cantidad;
        $(this).find('.subtotal').text(subtotal.toFixed(2));
        total += subtotal;
      });
      $('#total').val(total.toFixed(2));
    }

    $('#addProduct').click(function () {
      const selectedOption = productosSelect.find('option:selected');
      const productoId = selectedOption.val();

      if (!productoId) {
        alert('Selecciona un producto válido.');
        return;
      }

      const nombre = selectedOption.data('nombre');
      const precio = parseFloat(selectedOption.data('precio')).toFixed(2);
      const stock = parseInt(selectedOption.data('stock'));

      // Crear fila
      const row = $(`
        <tr data-producto-id="${productoId}">
          <td>
            ${nombre}
            <input type="hidden" name="productos_seleccionados[${contador}][producto_id]" value="${productoId}">
          </td>
          <td>${stock}</td>
          <td class="precio-unitario">${precio}</td>
          <td>
            <input style="width: 50px" type="number" name="productos_seleccionados[${contador}][cantidad]" class="form-control cantidad" value="1" min="<1" max="${stock}">
          </td>
          <td class="subtotal">${precio}</td>
          <td>
            <button type="button" class="btn btn-danger btn-sm eliminar-producto">X</button>
          </td>
        </tr>
      `);

      tablaProductos.append(row);
      selectedOption.prop('disabled', true);
      productosSelect.val(null).trigger('change');
      contador++;
      actualizarTotal();
    });

    // Delegación para eliminar producto
    tablaProductos.on('click', '.eliminar-producto', function () {
      const row = $(this).closest('tr');
      const productoId = row.data('producto-id');
      productosSelect.find(`option[value="${productoId}"]`).prop('disabled', false);
      row.remove();
      actualizarTotal();
    });

    // Delegación para cambio de cantidad
    tablaProductos.on('input change', '.cantidad', function () {
      const cantidadInput = $(this);
      const max = parseInt(cantidadInput.attr('max'));
      const val = parseInt(cantidadInput.val());
      if (val > max) {
        alert(`No hay suficiente stock. Máximo: ${max}`);
        cantidadInput.val(max);
      }
      else if (val < 1) {
        alert('La cantidad debe ser al menos 1.');
        cantidadInput.val(1);
      }
      document.getElementById('ventaForm')?.addEventListener('submit', function (e) {
    if (!totalInput.value || parseFloat(totalInput.value) <= 0) {
      e.preventDefault();
      alert('Debes seleccionar productos válidos y cantidades para calcular el total antes de enviar.');
    }
  });

      actualizarTotal();
    });
  });
</script>
{% endblock %}
